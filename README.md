# 基于muduo和protobuf的RPC框架
本项目实现了一个基于 Muduo 网络库金和 Protobuf 序列化的高性能RPC 框架，支持服务注册于发现、自动序列化、异步通信等特性。

---
### 服务调用方

---

服务调用方通过 protobuf 自动生成的 stub 代理类进行远程调用。构造 stub 时传入 MpRpcChannel，设置好调用参数后，直接调用 stub 的方法即可。stub 方法内部会统一通过 MpRpcChannel 重写的 CallMethod 发起 RPC 请求。主要流程如下：

1. **构建请求数据包**  
   按照约定格式组织请求数据：[header_size（4字节）][数据头（service_name|method_name|args_size）][参数内容]。

2. **序列化参数与数据头**  
   对参数和数据头分别进行序列化，拼接成完整的请求消息。

3. **服务发现**  
   通过 service_name 和 method_name 从 ZooKeeper 查询对应服务的 IP 和端口。

4. **网络通信**  
   根据获取到的 IP 和端口建立 socket 连接，发送 RPC 调用请求，并阻塞等待服务端响应。

5. **结果处理**  
   接收服务端返回的数据，对结果进行反序列化，并将最终结果返回给调用者。

---

### 服务发布方

服务发布方负责将本地实现的服务通过 RPC 框架对外发布，使客户端能够远程调用。主要流程如下：

1. **服务实现与注册**  
   开发者实现具体的服务类（继承自 protobuf 自动生成的服务基类），并将其注册到 RpcProvider 中，完成服务与方法的本地映射。

2. **启动网络服务**  
   RpcProvider 启动 Muduo 网络服务器，设置连接和消息回调，监听指定端口，准备接收来自客户端的 RPC 请求。

3. **服务信息注册到 ZooKeeper**  
   启动时，RpcProvider 会将所有已注册的服务及其方法信息同步到 ZooKeeper。服务节点以永久节点形式创建，方法节点以临时节点形式创建，并在方法节点中记录当前服务提供者的 IP 和端口，便于客户端发现和路由。

4. **请求接收与处理**  
   当收到客户端的 RPC 调用请求后，RpcProvider 解析请求数据，查找本地映射表，定位到对应的服务和方法，并调用实际的业务逻辑。

5. **结果返回**  
   业务方法执行完成后，RpcProvider 将结果序列化，通过网络返回给客户端，完成一次完整的远程调用流程。

---
### RpcProvider


---

`RpcProvider` 是整个 RPC 框架的核心组件，主要职责如下：

1. **服务注册与管理**  
   接收服务发布方注册的服务对象，并将服务及其包含的方法信息维护在内部的映射表（map）中，便于后续查找和调用。

2. **服务发布与节点注册**  
   启动 Muduo 网络服务器，绑定连接和消息回调。同时，将已注册的服务及其方法信息同步到 ZooKeeper：服务节点作为永久节点创建，方法节点作为临时节点创建，并在方法节点中保存当前服务提供者的 IP 和端口，便于客户端服务发现和负载均衡。

3. **请求处理与方法分发**  
   在消息回调中，接收并解析 RPC 调用请求，通过反序列化获取请求头和参数。根据服务名和方法名在本地映射表中查找对应的服务和方法，查找到后为方法调用绑定回调函数（用于序列化响应并通过网络返回给调用方），最后通过 CallMethod 动态分发并执行实际的业务方法。

---